# Build and Push Worker Images to DigitalOcean Container Registry
#
# This workflow builds Docker images for all K8s job workers
# and pushes them to DOCR on merge to main.
#
# Prerequisites:
# 1. Create a DigitalOcean Container Registry (DOCR)
# 2. Add secrets to your GitHub repository:
#    - DIGITALOCEAN_ACCESS_TOKEN: Your DO API token
#    - REGISTRY_NAME: Your DOCR registry name (e.g., "oikion")
#
# Images are tagged with:
# - Git SHA (for traceability)
# - 'latest' (for convenience)

name: Build Worker Images

on:
  push:
    branches:
      - main
    paths:
      - 'services/**'
      - '.github/workflows/build-workers.yml'
  pull_request:
    branches:
      - main
    paths:
      - 'services/**'
  workflow_dispatch:
    inputs:
      worker:
        description: 'Worker to build (or "all")'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - scraper
          - newsletter-worker
          - portal-worker
          - export-worker
          - worker-base

env:
  REGISTRY: registry.digitalocean.com
  REGISTRY_NAME: ${{ secrets.REGISTRY_NAME || 'oikion' }}

jobs:
  # ===========================================
  # Detect which workers changed
  # ===========================================
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      workers: ${{ steps.filter.outputs.workers }}
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect changed workers
        id: filter
        env:
          EVENT_NAME: ${{ github.event_name }}
          INPUT_WORKER: ${{ github.event.inputs.worker }}
        run: |
          if [ "$EVENT_NAME" == "workflow_dispatch" ]; then
            if [ "$INPUT_WORKER" == "all" ]; then
              echo "workers=scraper,newsletter-worker,portal-worker,export-worker,worker-base" >> $GITHUB_OUTPUT
            else
              echo "workers=$INPUT_WORKER" >> $GITHUB_OUTPUT
            fi
          else
            # Get list of changed files
            CHANGED=$(git diff --name-only HEAD~1 HEAD | grep '^services/' | cut -d'/' -f2 | sort -u | tr '\n' ',')
            echo "workers=${CHANGED%,}" >> $GITHUB_OUTPUT
          fi

      - name: Set build matrix
        id: set-matrix
        env:
          WORKERS: ${{ steps.filter.outputs.workers }}
        run: |
          if [ -z "$WORKERS" ]; then
            echo "matrix=[]" >> $GITHUB_OUTPUT
          else
            # Convert comma-separated to JSON array
            MATRIX=$(echo "$WORKERS" | tr ',' '\n' | jq -R . | jq -s .)
            echo "matrix=$MATRIX" >> $GITHUB_OUTPUT
          fi

  # ===========================================
  # Build and push worker images
  # ===========================================
  build:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.matrix != '[]'
    strategy:
      fail-fast: false
      matrix:
        worker: ${{ fromJson(needs.detect-changes.outputs.matrix) }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

      - name: Log in to DigitalOcean Container Registry
        run: doctl registry login --expiry-seconds 1200

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.REGISTRY_NAME }}/${{ matrix.worker }}
          tags: |
            type=sha,prefix=
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: ./services/${{ matrix.worker }}
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ env.REGISTRY_NAME }}/${{ matrix.worker }}:buildcache
          cache-to: type=registry,ref=${{ env.REGISTRY }}/${{ env.REGISTRY_NAME }}/${{ matrix.worker }}:buildcache,mode=max

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        if: github.event_name != 'pull_request'
        with:
          image-ref: ${{ env.REGISTRY }}/${{ env.REGISTRY_NAME }}/${{ matrix.worker }}:${{ github.sha }}
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v3
        if: github.event_name != 'pull_request' && always()
        with:
          sarif_file: 'trivy-results.sarif'

  # ===========================================
  # Notify on completion
  # ===========================================
  notify:
    runs-on: ubuntu-latest
    needs: build
    if: always()
    env:
      BUILD_RESULT: ${{ needs.build.result }}
    steps:
      - name: Report status
        run: |
          if [ "$BUILD_RESULT" == "success" ]; then
            echo "✅ All worker images built and pushed successfully"
          elif [ "$BUILD_RESULT" == "failure" ]; then
            echo "❌ One or more worker builds failed"
            exit 1
          else
            echo "⏭️ No worker changes detected, build skipped"
          fi
