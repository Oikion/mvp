# RBAC for Job Orchestrator (running in Next.js API)
# Allows the orchestrator to create/manage jobs in the oikion-jobs namespace
apiVersion: v1
kind: ServiceAccount
metadata:
  name: job-orchestrator
  namespace: oikion-jobs
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: job-manager
  namespace: oikion-jobs
rules:
  # Job management
  - apiGroups: ["batch"]
    resources: ["jobs"]
    verbs: ["create", "get", "list", "watch", "delete"]
  # Pod access for logs
  - apiGroups: [""]
    resources: ["pods"]
    verbs: ["get", "list", "watch"]
  - apiGroups: [""]
    resources: ["pods/log"]
    verbs: ["get"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: job-orchestrator-binding
  namespace: oikion-jobs
subjects:
  - kind: ServiceAccount
    name: job-orchestrator
    namespace: oikion-jobs
roleRef:
  kind: Role
  name: job-manager
  apiGroup: rbac.authorization.k8s.io
---
# Network Policy - restrict pod-to-pod communication
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: job-isolation
  namespace: oikion-jobs
spec:
  podSelector: {}
  policyTypes:
    - Ingress
    - Egress
  egress:
    # Allow DNS resolution
    - to:
        - namespaceSelector: {}
          podSelector:
            matchLabels:
              k8s-app: kube-dns
      ports:
        - protocol: UDP
          port: 53
    # Allow outbound HTTPS (for API calls, database, etc.)
    - to:
        - ipBlock:
            cidr: 0.0.0.0/0
      ports:
        - protocol: TCP
          port: 443
        - protocol: TCP
          port: 5432  # PostgreSQL
        - protocol: TCP
          port: 6379  # Redis
  ingress: []  # No inbound traffic needed for jobs
