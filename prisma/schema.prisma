// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Clients {
  id                   String             @id @default(uuid())
  createdAt            DateTime           @default(now())
  createdBy            String?
  updatedAt            DateTime?          @updatedAt
  updatedBy            String?
  assigned_to          String?
  organizationId      String             @default("00000000-0000-0000-0000-000000000000")

  // Core client identity
  client_name          String
  primary_email        String?

  // Greece-specific client fields
  person_type          PersonType?
  full_name            String?
  company_name         String?
  primary_phone        String?
  secondary_phone      String?
  secondary_email      String?
  intent               ClientIntent?
  channels             String[]           // CALL, SMS, WHATSAPP, VIBER, EMAIL
  language             Language?          @default(en)
  afm                  String?            // Greek tax ID (9 digits)
  doy                  String?            // Greek tax office
  id_doc               String?            // ID/Passport
  company_gemi         String?            // Greek business registry
  purpose              PropertyPurpose?
  areas_of_interest    Json?               // Array of areas
  budget_min           Decimal?
  budget_max           Decimal?
  timeline             Timeline?
  financing_type       FinancingType?
  preapproval_bank     String?
  needs_mortgage_help  Boolean?           @default(false)
  gdpr_consent         Boolean?           @default(false)
  allow_marketing      Boolean?           @default(false)
  lead_source          LeadSource?
  draft_status         Boolean?           @default(false)

  // Real-estate specific fields
  client_type          ClientType?
  client_status        ClientStatus?      @default(LEAD)
  property_preferences Json?
  communication_notes  Json?

  // Address and misc
  billing_city         String?
  billing_country      String?
  billing_postal_code  String?
  billing_state        String?
  billing_street       String?
  company_id           String?
  description          String?
  fax                  String?
  member_of            String?
  office_phone         String?
  shipping_city        String?
  shipping_country     String?
  shipping_postal_code String?
  shipping_state       String?
  shipping_street      String?
  vat                  String?
  website              String?

  // Relations
  documentsIDs         String[]
  assigned_documents   Documents[]        @relation("DocumentsToClients")
  contacts             Client_Contacts[]
  assigned_to_user     Users?             @relation(fields: [assigned_to], references: [id])
  crm_accounts_tasks   crm_Accounts_Tasks[]
  watchers             String[]
  watching_users       Users[]            @relation("watching_accounts")
  linked_properties    Client_Properties[]
  linkedEvents         CalComEvent[]      @relation("EventToClients")

  // Performance indexes for frequently queried fields
  @@index([client_status])
  @@index([createdAt])
  @@index([assigned_to])
  @@index([organizationId])
}

enum ClientType {
  BUYER
  SELLER
  RENTER
  INVESTOR
  REFERRAL_PARTNER
}

enum ClientStatus {
  LEAD
  ACTIVE
  INACTIVE
  CONVERTED
  LOST
}

enum PersonType {
  INDIVIDUAL
  COMPANY
  INVESTOR
  BROKER
}

enum ClientIntent {
  BUY
  RENT
  SELL
  LEASE
  INVEST
}

enum PropertyPurpose {
  RESIDENTIAL
  COMMERCIAL
  LAND
  PARKING
  OTHER
}

enum Timeline {
  IMMEDIATE
  ONE_THREE_MONTHS
  THREE_SIX_MONTHS
  SIX_PLUS_MONTHS
}

enum FinancingType {
  CASH
  MORTGAGE
  PREAPPROVAL_PENDING
}

enum LeadSource {
  REFERRAL
  WEB
  PORTAL
  WALK_IN
  SOCIAL
}

// Removed legacy crm_ Leads and related enums

// Removed legacy Opportunities and Campaigns related models and enums

model Client_Contacts {
  id                     String              @id @default(uuid())
  client                 String?
  assigned_to            String?
  birthday               String?
  created_by             String?
  createdBy              String?
  organizationId        String            @default("00000000-0000-0000-0000-000000000000")
  created_on             DateTime?           @default(now())
  cratedAt               DateTime?           @default(now())
  last_activity          DateTime?           @default(now())
  updatedAt              DateTime?           @updatedAt
  updatedBy              String?
  last_activity_by       String?
  description            String?
  email                  String?
  personal_email         String?
  contact_first_name     String?
  contact_last_name      String
  office_phone           String?
  mobile_phone           String?
  website                String?
  position               String?
  status                 Boolean             @default(true)
  // Real-estate specific
  contact_type           ClientContactType?
  relationship_to_client String?
  type                   String?             @default("Customer")
  tags                   String[]
  notes                  String[]
  assigned_to_user       Users?              @relation("assigned_contacts", fields: [assigned_to], references: [id])
  crate_by_user          Users?              @relation("created_contacts", fields: [created_by], references: [id])
  clientsIDs             String?
  assigned_client        Clients?            @relation(fields: [clientsIDs], references: [id])
  documentsIDs           String[]
  assigned_documents     Documents[]         @relation("DocumentsToClientContacts")

  // Performance indexes for frequently queried fields
  @@index([clientsIDs])
  @@index([assigned_to])
  @@index([created_on])
  @@index([organizationId])
}

enum ClientContactType {
  PRIMARY
  SECONDARY
  EMERGENCY
  REFERRAL
}

// Removed legacy crm_Contracts and related enum

model Employees {
  id     String  @id @default(uuid())
  avatar String
  email  String?
  name   String
  salary Int
  status String
}

model ImageUpload {
  id String @id @default(uuid())
}

model MyAccount {
  id                   String  @id @default(uuid())
  company_name         String
  organizationId       String            @default("00000000-0000-0000-0000-000000000000")
  is_person            Boolean @default(false)
  email                String?
  email_accountant     String?
  phone_prefix         String?
  phone                String?
  mobile_prefix        String?
  mobile               String?
  fax_prefix           String?
  fax                  String?
  website              String?
  // office Address
  street               String?
  city                 String?
  state                String?
  zip                  String?
  country              String?
  country_code         String?
  // billing Address
  billing_street       String?
  billing_city         String?
  billing_state        String?
  billing_zip          String?
  billing_country      String?
  billing_country_code String?
  //other
  currency             String?
  currency_symbol      String?
  VAT_number           String
  TAX_number           String?
  bank_name            String?
  bank_account         String?
  bank_code            String?
  bank_IBAN            String?
  bank_SWIFT           String?

  @@index([organizationId])
}

model Documents {
  id                     String              @id @default(uuid())
  date_created           DateTime?           @default(now())
  createdAt              DateTime?           @default(now())
  last_updated           DateTime?           @updatedAt
  updatedAt              DateTime?           @updatedAt
  document_name          String
  created_by_user        String?
  createdBy              String?
  organizationId        String            @default("00000000-0000-0000-0000-000000000000")
  description            String?
  document_type          String?
  favourite              Boolean?
  document_file_mimeType String
  document_file_url      String
  status                 String?
  visibility             String?
  tags                   Json?
  key                    String?
  size                   Int?
  assigned_user          String?
  connected_documents    String[]
  contactsIDs            String[]
  crm_accounts_tasksIDs  String[]
  accountsIDs            String[]
  contacts               Client_Contacts[]   @relation("DocumentsToClientContacts")
  crm_accounts_tasks     crm_Accounts_Tasks[] @relation("DocumentsToCrmAccountsTasks")
  accounts               Clients[]            @relation("DocumentsToClients")
  created_by             Users?              @relation("created_by_user", fields: [created_by_user], references: [id])
  assigned_to_user       Users?              @relation("assigned_to_user", fields: [assigned_user], references: [id])
  documents_type         Documents_Types?    @relation(fields: [document_type], references: [id])
  document_system_type   DocumentSystemType? @default(OTHER)

  // Papermark integration fields
  shareableLink           String?             @unique
  linkEnabled            Boolean             @default(false)
  passwordProtected      Boolean             @default(false)
  passwordHash           String?
  expiresAt              DateTime?
  linkedPropertiesIds    String[]
  linkedProperties        Properties[]       @relation("DocumentsToProperties")
  linkedCalComEventsIds  String[]
  linkedCalComEvents      CalComEvent[]      @relation("DocumentsToCalComEvents")
  linkedTasksIds         String[]
  linkedTasks             crm_Accounts_Tasks[] @relation("DocumentsToTasksExplicit")
  mentions                Json?              // Merged mentions: {clients: [...], properties: [...], events: [...], tasks: [...]}
  viewsCount              Int                 @default(0)
  lastViewedAt           DateTime?
  views                   DocumentView[]

  // Performance indexes for frequently queried fields
  @@index([date_created])
  @@index([assigned_user])
  @@index([created_by_user])
  @@index([organizationId])
  @@index([shareableLink])
  @@index([linkEnabled])
}

enum DocumentSystemType {
  INVOICE
  RECEIPT
  CONTRACT
  OFFER
  OTHER
}

model Documents_Types {
  id                 String      @id @default(uuid())
  name               String
  assigned_documents Documents[]
}

// Removed legacy crm_Industry_Type

model modulStatus {
  id        String  @id @default(uuid())
  name      String
  isVisible Boolean
}

model crm_Accounts_Tasks {
  id            String                      @id @default(uuid())
  content       String?
  createdAt     DateTime?                   @default(now())
  createdBy     String?
  updatedAt     DateTime?                   @updatedAt
  updatedBy     String?
  dueDateAt     DateTime?                   @default(now())
  priority      String
  tags          Json?
  title         String
  likes         Int?                        @default(0)
  user          String?
  comments      crm_Accounts_Tasks_Comments[] @relation("CommentsToCrmTasks")
  documents     Documents[]                 @relation("DocumentsToCrmAccountsTasks")
  linkedDocuments Documents[]              @relation("DocumentsToTasksExplicit")
  assigned_user Users?                      @relation(fields: [user], references: [id])
  organizationId String @default("00000000-0000-0000-0000-000000000000")
  //CRM assigments
  account       String?
  crm_accounts  Clients?                    @relation(fields: [account], references: [id])
  // Cal.com integration
  calcomEventId String?
  calcomEvent   CalComEvent?                 @relation(fields: [calcomEventId], references: [id])

  @@index([organizationId])
}

model crm_Accounts_Tasks_Comments {
  id                      String              @id @default(uuid())
  comment                 String
  createdAt               DateTime            @default(now())
  crm_account_task       String
  user                    String
  organizationId        String            @default("00000000-0000-0000-0000-000000000000")
  assigned_crm_account_task crm_Accounts_Tasks? @relation("CommentsToCrmTasks", fields: [crm_account_task], references: [id], onDelete: Cascade)
  assigned_user           Users?              @relation(fields: [user], references: [id])

  @@index([organizationId])
}

model TodoList {
  id          String @id @default(uuid())
  createdAt   String
  description String
  title       String
  url         String
  user        String
}

enum ActiveStatus {
  ACTIVE
  INACTIVE
  PENDING
}

model Users {
  id                   String                @id @default(uuid())
  clerkUserId          String?               @unique
  account_name         String?
  avatar               String?
  email                String                @unique
  is_account_admin     Boolean               @default(false)
  is_admin             Boolean               @default(false)
  created_on           DateTime              @default(now())
  lastLoginAt          DateTime?
  name                 String?
  password             String?
  username             String?
  userStatus           ActiveStatus          @default(PENDING)
  userLanguage         Language              @default(en)
  created_by_documents Documents[]           @relation("created_by_user")
  assigned_documents   Documents[]           @relation("assigned_to_user")
  crm_accounts_tasks   crm_Accounts_Tasks[]
  crm_accounts_tasks_comments crm_Accounts_Tasks_Comments[]
  accounts             Clients[]
  // MLS relations
  properties           Properties[]
  assigned_contacts    Client_Contacts[]     @relation("assigned_contacts")
  crated_contacts      Client_Contacts[]     @relation("created_contacts")
  assigned_property_contacts Property_Contacts[]
  
  openAi_key           openAi_keys[]
  watching_accountsIDs String[]
  watching_accounts    Clients[]             @relation("watching_accounts")
  watching_propertiesIDs String[]
  watching_properties  Properties[]            @relation("watching_properties")
  feedback             Feedback[]
  
  documentViews        DocumentView[]

  // Performance indexes for frequently queried fields
  @@index([userStatus])
  @@index([email])
  @@index([clerkUserId])
}

enum Language {
  cz
  en
  de
  uk
  el
}

model system_Modules_Enabled {
  id       String  @id @default(uuid())
  name     String
  enabled  Boolean
  position Int
}

 

model openAi_keys {
  id              String @id @default(uuid())
  user            String
  organization_id String
  api_key         String
  assigned_user   Users? @relation(fields: [user], references: [id])
}

model systemServices {
  id              String  @id @default(uuid())
  name            String
  serviceUrl      String?
  serviceId       String?
  serviceKey      String?
  servicePassword String?
  servicePort     String?
  description     String?
}

model gpt_models {
  id          String     @id @default(uuid())
  model       String
  description String?
  status      gptStatus?
  created_on  DateTime?  @default(now())
}

enum gptStatus {
  ACTIVE
  INACTIVE
}

// MLS: Properties and Property_Contacts

model Properties {
  id                   String       @id @default(uuid())
  createdAt            DateTime     @default(now())
  createdBy            String?
  updatedAt            DateTime?    @updatedAt
  updatedBy            String?
  assigned_to          String?
  organizationId      String             @default("00000000-0000-0000-0000-000000000000")

  // Core property identity
  property_name        String
  primary_email        String?

  // MLS specific fields
  property_type        PropertyType?
  property_status      PropertyStatus? @default(ACTIVE)
  property_preferences Json?
  communication_notes  Json?

  // Greece-specific property fields
  transaction_type     TransactionType?
  is_exclusive         Boolean?           @default(false)
  municipality         String?
  area                 String?
  postal_code          String?
  address_privacy_level AddressPrivacyLevel?
  size_net_sqm         Decimal?
  size_gross_sqm       Decimal?
  floor                String?            // BASEMENT, GROUND, 1ST, ..., PENTHOUSE
  floors_total         Int?
  plot_size_sqm        Decimal?
  inside_city_plan     Boolean?
  build_coefficient    Decimal?
  coverage_ratio       Decimal?
  frontage_m           Decimal?
  heating_type         HeatingType?
  energy_cert_class    EnergyCertClass?
  renovated_year       Int?
  condition            PropertyCondition?
  elevator             Boolean?
  building_permit_no   String?
  building_permit_year Int?
  land_registry_kaek   String?
  legalization_status  LegalizationStatus?
  etaireia_diaxeirisis String?
  monthly_common_charges Decimal?
  amenities            Json?              // Array: AC, FIREPLACE, PARKING, etc.
  orientation          Json?              // Array: N, S, E, W
  furnished            FurnishedStatus?
  accessibility        String?
  price_type           PriceType?
  available_from       DateTime?
  accepts_pets         Boolean?
  min_lease_months     Int?
  portal_visibility    PortalVisibility?
  draft_status         Boolean?           @default(false)

  // Address and details
  address_street       String?
  address_city         String?
  address_state        String?
  address_zip          String?
  price                Int?
  bedrooms             Int?
  bathrooms            Float?
  square_feet          Int?
  lot_size             Float?
  year_built           Int?
  description          String?

  // Relations
  contacts             Property_Contacts[]
  assigned_to_user     Users?       @relation(fields: [assigned_to], references: [id])
  watchers             String[]
  watching_users       Users[]      @relation("watching_properties")
  linked_clients       Client_Properties[]
  linkedDocuments      Documents[]  @relation("DocumentsToProperties")
  linkedEvents         CalComEvent[] @relation("EventToProperties")

  // Performance indexes for frequently queried fields
  @@index([property_status])
  @@index([createdAt])
  @@index([assigned_to])
  @@index([organizationId])
}

enum PropertyType {
  RESIDENTIAL
  COMMERCIAL
  LAND
  RENTAL
  VACATION
}

enum PropertyStatus {
  ACTIVE
  PENDING
  SOLD
  OFF_MARKET
  WITHDRAWN
}

enum TransactionType {
  SALE
  RENTAL
  SHORT_TERM
  EXCHANGE
}

enum AddressPrivacyLevel {
  EXACT
  PARTIAL
  HIDDEN
}

enum HeatingType {
  AUTONOMOUS
  CENTRAL
  NATURAL_GAS
  HEAT_PUMP
  ELECTRIC
  NONE
}

enum EnergyCertClass {
  A_PLUS
  A
  B
  C
  D
  E
  F
  G
  H
  IN_PROGRESS
}

enum PropertyCondition {
  EXCELLENT
  VERY_GOOD
  GOOD
  NEEDS_RENOVATION
}

enum LegalizationStatus {
  LEGALIZED
  IN_PROGRESS
  UNDECLARED
}

enum FurnishedStatus {
  NO
  PARTIALLY
  FULLY
}

enum PriceType {
  RENTAL
  SALE
  PER_ACRE
  PER_SQM
}

enum PortalVisibility {
  PRIVATE
  SELECTED
  PUBLIC
}

model Property_Contacts {
  id                 String   @id @default(uuid())
  property           String?
  assigned_to        String?
  created_on         DateTime? @default(now())
  updatedAt          DateTime? @updatedAt
  updatedBy          String?
  description        String?
  email              String?
  phone              String?
  contact_first_name String?
  contact_last_name  String
  contact_type       String?

  assigned_to_user   Users?   @relation(fields: [assigned_to], references: [id])
  assigned_property  Properties? @relation(fields: [property], references: [id])
}

// Many-to-many relationship between Clients and Properties
model Client_Properties {
  id         String   @id @default(uuid())
  createdAt  DateTime @default(now())
  clientId   String
  propertyId String
  
  client     Clients   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  property   Properties @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@unique([clientId, propertyId])
  @@index([clientId])
  @@index([propertyId])
}

// Feedback model for user feedback submissions
model Feedback {
  id                   String    @id @default(uuid())
  createdAt            DateTime  @default(now())
  
  // User information
  userId               String?
  userEmail            String?
  userName             String?
  organizationId       String            @default("00000000-0000-0000-0000-000000000000")
  
  // Feedback content
  feedbackType         String    // bug, feature, general, question, other
  feedback             String    @db.Text
  
  // Technical details
  url                  String?
  userAgent            String?   @db.Text
  browserName          String?
  browserVersion       String?
  osName               String?
  osVersion            String?
  screenResolution     String?
  
  // Bug report specific (optional)
  hasScreenshot        Boolean   @default(false)
  hasConsoleLogs       Boolean   @default(false)
  consoleLogsCount     Int?      @default(0)
  
  // Metadata
  emailSent            Boolean   @default(false)
  emailSentAt          DateTime?
  
  // Relations
  user                 Users?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([createdAt])
  @@index([feedbackType])
  @@index([organizationId])
}

// Calendar Events Model
model CalComEvent {
  id              String   @id @default(uuid())
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  calcomEventId   Int      @unique // Unique event ID
  calcomUserId    Int      @default(0) // Not used anymore, kept for compatibility
  organizationId  String   @default("00000000-0000-0000-0000-000000000000") // Organization context
  
  // Event details
  title           String?
  description     String?  @db.Text
  startTime       DateTime
  endTime         DateTime
  location        String?
  status          String?  // scheduled, cancelled, completed
  
  // CRM Relations
  eventType       String?  // "property_viewing", "client_consultation", etc.
  attendeeEmail   String?  // For client bookings
  attendeeName    String?  // For client bookings
  notes           String?  @db.Text
  
  // Relations
  linkedTasks     crm_Accounts_Tasks[]
  linkedDocuments Documents[]  @relation("DocumentsToCalComEvents")
  linkedClients   Clients[]     @relation("EventToClients")
  linkedProperties Properties[] @relation("EventToProperties")
  
  @@index([calcomEventId])
  @@index([organizationId])
  @@index([startTime])
  @@index([eventType])
}

// Document analytics - tracks views for Papermark-style analytics
model DocumentView {
  id          String    @id @default(uuid())
  documentId  String
  document    Documents @relation(fields: [documentId], references: [id], onDelete: Cascade)
  viewedAt    DateTime  @default(now())
  viewerIp    String?
  viewerUserAgent String?  @db.Text
  viewerUserId String?
  viewerUser  Users?    @relation(fields: [viewerUserId], references: [id], onDelete: SetNull)
  
  @@index([documentId])
  @@index([viewedAt])
  @@index([viewerUserId])
}
